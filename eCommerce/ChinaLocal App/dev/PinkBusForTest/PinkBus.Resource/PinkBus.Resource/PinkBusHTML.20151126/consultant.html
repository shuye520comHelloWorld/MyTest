<!doctype html>
<html class="" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>{{title}}</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/jquery.datetimepicker.css" />
    <link rel="stylesheet" href="css/style.css">

</head>
<body class="activity-management">
<div class="page-header">
    <h1>导入抢报顾问</h1>
</div>
<div class="import__header consultant-import__header">
    <p><label>活动名称：</label> <span>长春终极会</span></p>
    <div class="checkbox">
            <label class="consultant-import__label checkbox-label">
                可抢报的活动时段  <span>(可多选)</span>：
            </label>
            <div class="form-group">
                <input id="check1" type="checkbox">
                <label for="check1" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
            <div class="form-group">
                <input id="check2" type="checkbox">
                <label for="check2" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
            <div class="form-group">
                <input id="check3" type="checkbox">
                <label for="check3" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
            <div class="form-group">
                <input id="check4" type="checkbox">
                <label for="check4" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
            <div class="form-group">
                <input id="check5" type="checkbox">
                <label for="check5" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
            <div class="form-group">
                <input id="check6" type="checkbox">
                <label for="check6" class="btn btn-danger btn-outline">2015-05-16 9:30 — 11：30</label>
            </div>
        </div>
    <div class="header-import__cards">
        <div class="form-group">
            <label for="" class="consultant-import__label">可抢报来宾券总数  <span>(可多选)</span>：</label>
            <input type="number" class="form-control" id="" placeholder="" min="0">
            <span>张</span>
        </div>
        <div class="form-group">
            <label for="">每人来宾券：</label>
            <input type="number" class="form-control" id="" placeholder="" min="0">
            <span>张</span>
        </div>
    </div>
</div>

<div class="import-table">
    <div class="consultant-import__btn">
        导入名单： <button type="button" class="btn  btn-d-w" data-toggle="modal" data-target="#importModal"> <span class="icon-danger-plus"></span> 导入顾问名单</button>
    </div>
    <table class="table table-striped table-bordered table-hover " id="editable" >
        <thead>
        <tr>
            <th width="25%">顾问编号</th>
            <th width="15%">姓名</th>
            <th width="20%">手机号</th>
            <th width="10%">职级</th>
            <th width="20%">身份证号</th>
            <th width="10%">操作</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td id="000000000062"  data-role="serialNumber">000000000062</td>
            <td data-role="name">王美玲</td>
            <td data-role="tel">13812341234</td>
            <td data-role="grade">30</td>
            <td data-role="IDNumber">666666888888884444</td>
            <td class="import-record__del"> <div class="btn btn-default">删除</div></td>
        </tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="6">
                    <a id="addNewRow" href="javascript:;" class="btn"><span class="icon-add"></span>  新增一行</a>
                    <span class="pull-right import-record">共<span>60</span>条记录</span>
                </td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="import__footer">
    <button type="button" class="btn btn-d-m btn-danger btn-outline">取消</button>
    <button type="button" class="btn btn-d-m btn-danger">确认</button>
</div>
<!-- Modal -->
<div class="modal fade import-modal" id="importModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" class="icon-close"></span></button>
                <h4 class="modal-title" id="myModalLabel">输入顾问编号</h4>
            </div>
            <div class="modal-body">
                <div>
                    <textarea class="form-control" rows="12" id="listTextarea"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <p>注：每个编号独立一行，不要在中间添加任何符号</p>
                <button type="button" class="btn btn-d-m btn-danger btn-outline" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-d-m btn-danger" id="submitList">确认</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" src="javascripts/jquery.min.js"></script>
<script type="text/javascript" src="javascripts/bootstrap.min.js"></script>

<!-- Data Tables jeditable-->
<script src="javascripts/jquery.jeditable.js"></script>

<script>
    var jEditableConfig = {
            "onblur": 'submit',  //默认是回车键提交 ，这里修改为失去焦点即提交
            "event":"dblclick",  //默认是单击可编辑 ， 这里修改为双击编辑
            "width": "90%",
            "height": "100%"
    };

    var jEditableCallback = function (value, settings, elem) {
        var $this = $(this);
        var valueTrim = value.trim();
        var selfRole = $this.data('role');
        var serialNumberTd = $this.closest('tr').find('td:first-child');
        var serialNumber = serialNumberTd.attr('id');
        var ifexist= -1;
        var updateStatus = listObj.update(serialNumber, selfRole, valueTrim);
        if(!valueTrim) return false;
        if(selfRole == 'serialNumber'){
            if(!updateStatus){
                if(serialNumber != valueTrim){
                    alert('无法修改，此顾问编号已在表格中存在');
                }
                return serialNumber;
            }
            $this.attr('id',valueTrim);
        }
        return(valueTrim);
    };
    var listObj = {
        list:[],
        serialNumbers:[],
        tmpId:0,
        find: function (id) {
            return this.serialNumbers.indexOf(id)
        },
        del: function (id) {
            var listIndex = this.find(id);
            if(listIndex<0) return;
            this.serialNumbers.splice(listIndex,1);
            this.list.splice(listIndex,1);
            return true;
        },
        push: function (data) {
            this.serialNumbers.push(data.serialNumber);
            this.list.push(data);
        },
        update: function (id,prop,value) {
            var context = this;
            var listIndex = this.find(id);
            if(prop == 'serialNumber'){
                if(this.find(value)>-1) return false;
                this.serialNumbers[listIndex] = value;
            }
            this.list[listIndex][prop] = value;
            return true;
        }
    };
    var pageConf= {
        // 新增行 --- 导入顾问，志愿者，抢票页 略有不同。
        newTr: function (data) {
            return '<tr>' +
                    '<td id="'+ (data.serialNumber || 'tmp'+ listObj.tmpId++) +'" data-role="serialNumber">'+ (data.serialNumber || '')+ '</td>' +
                    '<td data-role="name">'+ (data.name|| ' ') + '</td>' +
                    '<td data-role="tel">'+ (data.tel|| ' ') + '</td>' +
                    '<td data-role="grade">'+ (data.grade|| ' ') + '</td>' +
                    '<td data-role="IDNumber">'+ (data.IDNumber|| ' ') + '</td>' +
                    ' <td class="import-record__del"> <div class="btn btn-default">删除</div></td>' +
                    '</tr>'
        }
    };
   // $('#editable tbody').find('td:not(".import-record__del")').editable(jEditableCallback, jEditableConfig);

    $('#addNewRow').on('click',function(){
        var newTr = $(pageConf.newTr({}));
        listObj.push({ serialNumber : 'tmp'+ (listObj.tmpId-1) });
        newTr.find('td:not(".import-record__del")').editable(jEditableCallback, jEditableConfig);
       $('#editable').find('tbody').append(newTr);
    });

    $('#submitList').on('click', function () {
        var listTextarea = $('#listTextarea');
        var listTextareaValue = listTextarea.val();
        var desired = listTextareaValue.replace(/[^\w\s]/gi, ''); //去除所有特殊字符
        var listTextareaArray = desired.split("\n");
        listTextareaArray = listTextareaArray.map(function (v) {return v.trim();});
        listTextareaArray =  $.grep(listTextareaArray,function(n){ return(n) }); //去除空字符串 如最后一行是空的可能
        $.event.trigger({
            type: "modal.list",
            list: listTextareaArray,
            time: new Date()
        });
    });

    $(document).on('modal.list',function (e) {
        $.ajax({
            url:'/imports/consultant',
            type:'post',
            data:{list: e.list},
            dataType:'json'
        }).done(function(json) {
            $.event.trigger({
                type: "list.ajax.down",
                message: json,
                time: new Date()
            });
        }).fail(function() {
            alert('与服务器联系失败');
        });
    });


    $(document).on('list.ajax.down',function (e) {
        e.message.list.map(function(data){
            //验证现存
            if(listObj.serialNumbers.indexOf(data.serialNumber) > 0) return;
            listObj.push(data);
            var newTr = $(pageConf.newTr(data));
            newTr.find('td:not(".import-record__del")').editable(jEditableCallback, jEditableConfig);
            $('#editable tbody').append(newTr);

        });
    });


    $(document).on('list.ajax.down',function (e) {
        $('#importModal').modal('hide');
    });

    $('body').on('click.del','.import-record__del .btn', function (e) {
        var thisTr = $(this).closest('tr');
        var id = thisTr.find('td:first-child').attr('id');
        listObj.del(id);
        thisTr.remove();
    })

</script>


</body>
</html>
